version: 2
jobs:
  test-python-version:
    docker:
      - image: circleci/python:2.7.15
    steps:
      - checkout
      - run:
          name: Run test for Python 2.7.15
          command: |
            sudo python setup.py install
            python setup.py test
            ls examples/ | xargs -n 1 -I '{}' python examples/'{}'/main.py

  verify:
    docker:
      - image: circleci/python:2.7.15
    steps:
      - checkout
      - run:
          name: Verify if package version is same as repo tag
          command: |
            VERSION_TAG=$(git tag -l --points-at HEAD) python setup.py verify

  release:
    docker:
      - image: circleci/python:2.7.15
    steps:
      - checkout
      - run:
          name: Release to Pypi
          command: |
            # Install required packages
            python -m pip install --user --upgrade setuptools wheel twine

            # Setup Pypi config
            echo -e "[testpypi]" >> ~/.pypirc
            echo -e "repository:https://test.pypi.org/legacy/" >> ~/.pypirc
            echo -e "username:$PYPI_USERNAME" >> ~/.pypirc
            echo -e "password:$PYPI_PASSWORD" >> ~/.pypirc

            # Build package
            python setup.py sdist bdist_wheel

            # Upload package for distribution
            python -m twine upload --repository testpypi dist/*

workflows:
  version: 2
  test-and-deploy:
    jobs:
    - test-python-version
    - release:
        requires:
          - verify
        filters:
          tags:
            only: /^([0-9]+)\.([0-9]+)\.([0-9])?$/
          branches:
            ignore: /.*/
